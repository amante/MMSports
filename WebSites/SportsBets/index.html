<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBets — Cartillas por deporte / Mixta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="description" content="Importa Excel; soporta bloques de 4 y props FA (umbral + descripción). Autodetección de stat, comparación valor vs umbral, badges de resultado, odds editables." />
  <style>
    .card{transition:box-shadow .2s ease, transform .2s ease}
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.08);transform:translateY(-2px)}
    .drop{border:2px dashed #cbd5e1}
    table{border-collapse: separate; border-spacing: 0; min-width: 100%}
    th, td{border-bottom:1px solid #e5e7eb; padding:6px 10px; text-align:left; font-size:12px}
    th{position: sticky; top:0; background:#f8fafc; z-index:1}
    .badge{font-size:10px; padding:2px 6px; border-radius:999px; display:inline-block}
    .badge-green{background:#dcfce7;color:#065f46;border:1px solid #86efac}
    .badge-red{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .badge-gray{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    .kpi{background:white;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px}
    .kpi .v{font-weight:600}
    .btn{border:1px solid #e5e7eb;border-radius:10px;padding:4px 8px;font-size:12px}
    .tabs button.active{background:#0f172a;color:#fff}
    .hide-rs th.col-res, .hide-rs td.col-res,
    .hide-rs th.col-status, .hide-rs td.col-status { display: none; }
    @media print {
      #site-navbar, #dropzone, #parseBtn, #clearBtn, #hideResultsChk { display:none !important; }
      body { background:white; }
      .card, .kpi { border-color:#ddd; }
    }
  
    /* --- v1.25.1 UI polish --- */
    table.ticket-table{ table-layout: fixed; }
    th, td{ font-size:13px }
    .num, .num-input{ text-align:right; font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .num-input{ padding:6px 8px; width: 10ch; }
    .num-input.factor{ width: 9ch; } /* e.g., +120 or 1.85 */
    .nowrap{ white-space: nowrap; }
    /* Hide number spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type=number]{ -moz-appearance: textfield; }
    /* Column width plan */
    th.col-sport, td.col-sport { width: 110px; }
    th.col-winner, td.col-winner { width: 320px; }
    th.col-stat, td.col-stat { width: 110px; }
    th.col-umbral, td.col-umbral { width: 90px; }
    th.col-valor, td.col-valor { width: 110px; }
    th.col-tipo, td.col-tipo { width: 100px; }
    th.col-faltan, td.col-faltan { width: 100px; }
    th.col-factor, td.col-factor { width: 110px; }
        th.col-res, td.col-res { width: 120px; }
    th.col-status, td.col-status { width: 90px; }
    th.col-actions, td.col-actions { width: 110px; }
    /* KPIs slightly larger */
    .kpi .v{ font-size: 14px; }

  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="site-navbar"></div>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">SportsBets — Cartillas</h1>
      <div class="text-sm text-slate-500">v1.20</div>
    </div>

    
<section class="mt-6 space-y-6">
  <!-- Top toolbar: Carga de archivo + Modo impresión -->
  <div class="card bg-white rounded-2xl p-5 border border-slate-200">
    <div class="flex flex-col gap-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Carga de archivo</h2>
        <label class="flex items-center gap-2 text-sm">
          <input id="hideResultsChk" type="checkbox" class="h-4 w-4">
          Modo impresión (ocultar Resultado/Estado)
        </label>
      </div>
      <div id="dropzone" class="drop rounded-xl p-6 text-center bg-slate-50">
        <p class="text-sm text-slate-600 mb-2">Arrastra y suelta aquí, o</p>
        <label class="inline-block px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm cursor-pointer hover:bg-indigo-500">
          Seleccionar archivo
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
        </label>
        <p id="fileInfo" class="mt-2 text-xs text-slate-500">Sin archivo</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">Hoja</label>
          <select id="sheetSel" class="w-full rounded-xl border border-slate-200 p-2.5"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Fila inicial</label>
          <input id="startRow" type="number" min="1" step="1" value="1" class="w-full rounded-xl border border-slate-200 p-2.5" />
        </div>
        <div class="flex items-end flex-wrap gap-2">
          <button id="parseBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Leer</button>
          <button id="clearBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpiar</button>
          <button id="saveBtn" class="px-3 py-2 rounded-lg bg-emerald-700 text-white text-sm hover:bg-emerald-600">Guardar</button>
  <button id="restoreBtn" class="px-3 py-2 rounded-lg bg-slate-700 text-white text-sm hover:bg-slate-600">Restaurar</button>
  <button id="clearSavedBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Borrar guardadas</button>
</div>
      </div>
    </div>
  </div>

  <!-- Cartillas -->
  <div class="card bg-white rounded-2xl p-5 border border-slate-200">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Cartillas</h2>
      <div class="tabs flex items-center gap-2" id="tabsNav"></div>
    </div>
    <div id="tabsContent"></div>
  </div>
</section>

  </main>
  <div id="site-footer"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { wb:null, fileName:null, linesA:[], sheet:null, booklets:[], activeBooklet:0 };

    
    // Helpers for multi-cartillas
    function kB(i,s){ return `b${i}-${s}`; }
    function splitIntoSegments(arr, fromIdx){
      const out=[]; let cur=[];
      for(let k=fromIdx; k<arr.length; k++){
        const raw = (arr[k]||"").trim();
        if(raw === "---"){ break; }
        if(raw === ""){ if(cur.length){ out.push(cur); cur=[]; } continue; }
        cur.push(raw);
      }
      if(cur.length){ out.push(cur); }
      return out;
    }

    // ---- v1.25.1: persistence + delta 'faltan' helpers ----
    const STORAGE_KEY = 'mmsports_sportsbets_booklets_v1';
    function saveBooklets(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({booklets: state.booklets})); alert('Cartillas guardadas.'); }catch(e){ console.error(e); alert('No se pudo guardar.'); } }
    function loadBooklets(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw){ alert('No hay cartillas guardadas.'); return; } const o = JSON.parse(raw); if(!o || !o.booklets || !o.booklets.length){ alert('Guardado vacío.'); return; } state.booklets = o.booklets; state.activeBooklet = 0; renderTabs(); setFileInfo('Restaurado desde guardado local'); }catch(e){ console.error(e); alert('No se pudo restaurar.'); } }
    function clearSaved(){ try{ localStorage.removeItem(STORAGE_KEY); alert('Guardado eliminado.'); }catch(e){ console.error(e); } }
    function formatDelta(d){ if(!Number.isFinite(d)) return ''; return Math.abs(d - Math.round(d)) < 1e-9 ? String(Math.round(d)) : d.toFixed(2); }
    function computeDelta(it){
      const toNum = (val)=>{ const s=(val??'').toString().trim().replace(',', '.'); const n = Number(s); return Number.isFinite(n) ? n : NaN; };
      const u = toNum(it.umbral);
      const v = toNum(it.valor);
      if(!Number.isFinite(u) || !Number.isFinite(v)) return '';
      const tipo = (it.tipo||'over').toString().toLowerCase();
      if(tipo === 'under'){
        // cuántas yardas "sobran" para quedar por debajo o 0 si ya está por debajo
        return formatDelta(v < u ? 0 : (v - u));
      }else{
        // over: cuántas faltan para superar el umbral o 0 si ya supera
        return formatDelta(v > u ? 0 : (u - v));
      }
    }
    function setResultTextStyle(span, it){
      if(!span) return;
      const cls = classifyResult(it.resultado);
      span.classList.remove('text-emerald-700','font-semibold','text-red-700');
      if(cls === 'ganado'){ span.classList.add('text-emerald-700','font-semibold'); }
      else if(cls === 'perdido'){ span.classList.add('text-red-700','font-semibold'); }
    }
    function refreshDeltaForRow(bi, key, idx){
      const table = document.getElementById(kIdB(bi,key,'table'));
      const row = table?.querySelectorAll('tbody tr')[idx];
      if(!row) return;
      // column order: sport(0), winner(1), stat(2), umbral(3), valor(4), tipo(5), faltan(6), factor(7), resultado(8), status(9), actions(10)
      const tdF = row.children[6];
      const t = state.booklets[bi]?.ticket;
      const it = t?.lines[idx];
      if(!tdF || !it) return;
      tdF.textContent = computeDelta(it);
    }

    function slug(s){ return (s||'mixta').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'mixta'; }
    function setFileInfo(txt){ $("fileInfo").textContent = txt; }
    function clearAll(){
      state.wb=null; state.fileName=null; state.linesA=[]; state.built=[]; state.sheet=null; state.tickets={}; state.active=null;
      $("sheetSel").innerHTML = ""; setFileInfo("Sin archivo");
      $("tabsNav").innerHTML = ""; $("tabsContent").innerHTML="";
    }
    function handleDrop(e){
      e.preventDefault(); e.stopPropagation();
      const dt=e.dataTransfer; if(!dt || !dt.files || !dt.files[0]) return;
      const f=dt.files[0]; $("fileInput").files = dt.files; loadFile(f);
      e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300");
    }
    function loadFile(file){
      state.fileName=file.name; setFileInfo("Archivo: "+file.name+" ("+Math.round(file.size/1024)+" KB)");
      const reader=new FileReader();
      reader.onload = function(ev){
        try{ const data=new Uint8Array(ev.target.result); state.wb = XLSX.read(data, { type:'array' }); populateSheets(); try{ parseSheet(); }catch(e){} }
        catch(err){ alert("No se pudo leer el archivo."); console.error(err); }
      };
      reader.readAsArrayBuffer(file);
    }
    function populateSheets(){
      const sheets = state.wb.SheetNames || [];
      const sel = $("sheetSel"); sel.innerHTML="";
      sheets.forEach((s,i)=>{ const opt=document.createElement("option"); opt.value=s; opt.textContent=s+(i===0?" (sugerida)":""); sel.appendChild(opt); });
      state.sheet = sheets[0] || null;
    }
    function parseSheet(){
      const sheetName = $("sheetSel").value || state.sheet;
      if(!sheetName){ alert("No hay hojas."); return; }
      const ws = state.wb.Sheets[sheetName];
      const arr = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
      const start = Math.max(1, parseInt($("startRow").value||"1",10)) - 1;
      const lines = [];
      for(let i=0;i<arr.length;i++){ const row = arr[i]; const val = row && row.length ? String(row[0] ?? "").trim() : ""; lines.push(val); }
      state.sheet = sheetName; state.linesA = lines;
      buildLines(start);
    }
    function normalizeOdds(v){
      const s = (v ?? "").toString().trim().replace(",", ".");
      if(!s) return null;
      if(/^[+-]\d+(?:\.\d+)?$/.test(s)) return { type:"american", value: parseFloat(s) };
      const num = Number(s); if(Number.isFinite(num)) return { type:"decimal", value: num };
      return { type:"raw", value: (v ?? "").toString() };
    }
    function toDecimalFactor(f){
      const x = Number(f);
      if(!Number.isFinite(x)) return null;
      if(Math.abs(x) >= 100 || x <= -100 || x >= 100){ if(x > 0) return 1 + (x/100); if(x < 0) return 1 + (100/Math.abs(x)); }
      if(x >= 1.01) return x; return null;
    }
    function splitTeams(raw){
      if(!raw) return {home:"",away:""};
      const s = raw.toString();
      const seps = [" vs ", " vs. ", " v ", " @ ", " - ", " — ", " – "];
      for(const sep of seps){ if(s.includes(sep)){ const parts=s.split(sep); if(parts.length>=2) return {home:(parts[0]||"").trim(), away:(parts[1]||"").trim()}; } }
      const m = s.split(/\s+(?:vs\.?|v|@|\-+|—|–)\s+/i);
      if(m.length>=2) return {home:(m[0]||"").trim(), away:(m[1]||"").trim()};
      return {home:s.trim(), away:""};
    }
    function inferSport(typeStr){
      const t=(typeStr||"").toString().trim().toLowerCase();
      if(t === "ganador") return "Tenis";
      if(t.includes("resultado del partido") || (t.includes("resultado") && t.includes("partido"))) return "Fútbol";
      return t || "Otro";
    }
    function detectStat(desc){
      const d = (desc||"").toString().toLowerCase();
      const has = (kws)=>kws.some(k=>d.includes(k));
      if(has(["yardas de pase","pase","passing"])) return "pase";
      if(has(["recepciones","recepción","yardas recibidas","receiving"])) return "recepción";
      if(has(["yardas por tierra","yardas terrestres","carrera","acarreo","rush","rushing"])) return "carrera";
      if(has(["td","touchdown"])) return "touchdowns";
      if(has(["intercepciones","interception"])) return "intercepciones";
      return "otro";
    }
    function buildLines(startIdx=0){
  const arr = state.linesA;
  // segmentación por filas vacías; '---' termina lectura
  const segments = splitIntoSegments(arr, startIdx);

  function adapterBlocks4(lines){
    const out=[];
    for(let i=0;i<lines.length;i+=4){
      const a1 = lines[i]||""; const a2=lines[i+1]||""; const a3=lines[i+2]||""; const a4=lines[i+3]||"";
      if(!a1 && !a2 && !a3 && !a4) continue;
      const sport = inferSport(a3); const teams = splitTeams(a4); const odd = normalizeOdds(a2);
      out.push({ sport: sport||"", winner:a1, stat:"", umbral:null, valor:"", tipo:"", factor: odd?odd.value:"", home:teams.home, away:teams.away, resultado:"" });
    }
    return out;
  }
  function adapterFAProps(lines){
    const thrRe = /^\s*(\d+(?:\.\d+)?)\+\s*$/;
    const out=[]; let i=0;
    while(i < lines.length){
      const a = (lines[i]||"").trim();
      const m = a.match(thrRe);
      if(m){
        let j=i+1, desc="";
        while(j<lines.length){
          const b=(lines[j]||"").trim();
          if(b){ desc=b; break; }
          j++;
        }
        if(desc){
          const umbral = parseFloat(m[1]);
          const stat = detectStat(desc);
          const winner = `${desc} (${m[1]}+)`;
          out.push({ sport:"Fútbol Americano", winner, stat, umbral, valor:"", tipo:"over", factor:"", home:"", away:"", resultado:"" });
          i = j+1; continue;
        } else { i++; continue; }
      } else { i++; }
    }
    return out;
  }

  // Construir cartillas (booklets)
  const booklets = [];
  segments.forEach((seg, idx)=>{
    const built4 = adapterBlocks4(seg);
    const builtFA = adapterFAProps(seg);
    const built = (builtFA.length && builtFA.length >= built4.length) ? builtFA : built4;
    if(!built.length) return;
    const sports = Array.from(new Set(built.map(b=>b.sport || "Otro")));
    let ticket;
    if(sports.length > 1){
      ticket = { key:"mixta", label:"Mixta", stake:10, pendingMode:"ignore1", lines: built.map(x=>Object.assign({},x)) };
    }else{
      const s = sports[0] || "Otro";
      const key = slug(s);
      ticket = { key, label:s, stake:10, pendingMode:"ignore1", lines: built.filter(x=>x.sport===s).map(x=>Object.assign({},x)) };
    }
    booklets.push({ label:`Cartilla ${booklets.length+1}`, ticket });
  });
  state.booklets = booklets;
  state.activeBooklet = 0;
  renderTabs();
}
    function buildTickets(){
      const sports = Array.from(new Set(state.built.map(b=>b.sport || "Otro")));
      const tickets = {};
      if(sports.length > 1){
        tickets["mixta"] = { key:"mixta", label:"Mixta", stake:10, pendingMode:"ignore1", lines: state.built.map(x=>Object.assign({},x)) };
      }else{
        const s = sports[0] || "Otro";
        const key = slug(s);
        tickets[key] = { key, label:s, stake:10, pendingMode:"ignore1", lines: state.built.filter(x=>x.sport===s).map(x=>Object.assign({},x)) };
      }
      state.tickets = tickets;
      state.active = Object.keys(tickets)[0] || null;
    }
    function classifyResult(v){
      const s = (v||"").toString().trim().toLowerCase();
      const noAcc = s.normalize('NFD').replace(/\p{Diacritic}/gu, '');
      const win = new Set(["ganado","ganada","win","won","ok","si","sí","yes","true"]);
      const lose = new Set(["perdido","perdida","lose","lost","no","fail","false"]);
      const pend = new Set(["pendiente","pending","-","—","en curso","running"]);
      if(win.has(noAcc)) return "ganado";
      if(lose.has(noAcc)) return "perdido";
      if(!noAcc || pend.has(noAcc)) return "pendiente";
      return "pendiente";
    }
    function kId(key, suffix){ return key+"-"+suffix; }
    function kIdB(i,key,suffix){ return kB(i, kId(key,suffix)); }
    function computeTotalsForB(bi, key){
      const t = state.booklets[bi]?.ticket; if(!t || t.key!==key) return;
      let prod=1.0, count=0;
      for(const it of t.lines){ const dec=toDecimalFactor(it.factor); if(dec && dec>0){ prod*=dec; count++; } }
      const stake = Number((document.getElementById(kIdB(bi,key,"stake")).value)||0);
      const oddTotal = (count>0) ? prod : 0;
      const retorno = oddTotal * stake; const ganancia = retorno - stake;
      document.getElementById(kIdB(bi,key,"oddTotal")).textContent = (oddTotal? oddTotal.toFixed(4) : "—");
      document.getElementById(kIdB(bi,key,"retorno")).textContent = (oddTotal? retorno.toFixed(2) : "—");
      document.getElementById(kIdB(bi,key,"ganancia")).textContent = (oddTotal? ganancia.toFixed(2) : "—");
    }
    function computeEffectiveForB(bi, key){
      const t = state.booklets[bi]?.ticket; if(!t || t.key!==key) return;
      const stake = Number((document.getElementById(kIdB(bi,key,"stake")).value)||0);
      const mode = document.getElementById(kIdB(bi,key,"pendingMode")).value;
      let hasLost=false, allWon=true;
      let prodWins=1.0, wins=0;
      for(const it of t.lines){
        const cls = classifyResult(it.resultado);
        if(cls === "perdido") hasLost = true;
        if(cls !== "ganado") allWon = false;
        if(cls === "ganado"){ const dec=toDecimalFactor(it.factor); if(dec && dec>0){ prodWins*=dec; wins++; } }
      }
      let status="Pendiente", retornoEf=0, ganEf=0, show=false;
      if(hasLost){ status="Perdida"; retornoEf=0; show=true; ganEf=-stake; }
      else if(allWon && wins>0){ status="Ganada"; retornoEf=prodWins*stake; show=true; ganEf=retornoEf-stake; }
      else {
        status="Pendiente";
        if(mode==="ignore1"){ retornoEf= wins>0 ? prodWins*stake : 0; show = wins>0; ganEf = show ? (retornoEf-stake) : 0; }
        else { retornoEf=0; show=false; ganEf=0; }
      }
      document.getElementById(kIdB(bi,key,"ticketStatus")).textContent = status;
      document.getElementById(kIdB(bi,key,"retornoEfectivo")).textContent = show? retornoEf.toFixed(2) : "—";
      document.getElementById(kIdB(bi,key,"gananciaEfectiva")).textContent = show? ganEf.toFixed(2) : "—";
    }
    function applyHideCols(){
      const chk = document.getElementById("hideResultsChk");
      const tables = document.querySelectorAll("table.ticket-table");
      tables.forEach(tbl=>{ if(chk && chk.checked) tbl.classList.add("hide-rs"); else tbl.classList.remove("hide-rs"); });
    }
    function setRowBadge(td, it){
      td.innerHTML="";
      const cls = classifyResult(it.resultado);
      if(cls === "ganado"){ const b=document.createElement("span"); b.className="badge badge-green"; b.textContent="Ganado"; td.appendChild(b); }
      else if(cls === "perdido"){ const b=document.createElement("span"); b.className="badge badge-red"; b.textContent="Perdido"; td.appendChild(b); }
      else { const b=document.createElement("span"); b.className="badge badge-gray"; b.textContent="Pendiente"; td.appendChild(b); }
    }
    function autoEvalResult(it){
      const toNum = (val)=>{ const s=(val??"").toString().trim().replace(",","."); const n = Number(s); return Number.isFinite(n) ? n : NaN; };
      const u = toNum(it.umbral);
      const v = toNum(it.valor);
      if(Number.isFinite(u) && Number.isFinite(v)){
        const tipo = (it.tipo||"over").toString().toLowerCase();
        if(tipo === "under"){ it.resultado = (v < u) ? "Ganado" : "Perdido"; }
        else { it.resultado = (v > u) ? "Ganado" : "Perdido"; }
      } else if(!it.resultado){
        it.resultado = "";
      }
    }
    function renderTicketContentB(bi){
      const booklet = state.booklets[bi];
      const t = booklet.ticket;
      const key = t.key;
      const wrap = document.createElement("div"); wrap.id = kB(bi, key+"-content");
      wrap.innerHTML = `
        <div class="grid grid-cols-1 gap-4">
          <div class="kpi">Cartilla: <span class="v">${booklet.label}</span> — Deporte: <span class="v">${t.label}</span></div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
            <div>
              <label class="block text-sm font-medium mb-1">Monto (stake)</label>
              <input id="${kIdB(bi,key,"stake")}" type="number" min="0" step="0.01" value="10" class="w-full rounded-xl border border-slate-200 p-2.5" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Modo de pendientes</label>
              <select id="${kIdB(bi,key,"pendingMode")}" class="w-full rounded-xl border border-slate-200 p-2.5">
                <option value="ignore1">Pendientes = 1 (retorno parcial)</option>
                <option value="strict0">Parlay estricto (pendientes = 0)</option>
              </select>
            </div>
          </div>
          <div id="${kIdB(bi,key,"mixtaSummaryWrap")}" class="mt-2"></div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-2">
            <div class="kpi">ODD total: <span id="${kIdB(bi,key,"oddTotal")}" class="v">—</span></div>
            <div class="kpi">Retorno potencial: <span id="${kIdB(bi,key,"retorno")}" class="v">—</span></div>
            <div class="kpi">Ganancia neta: <span id="${kIdB(bi,key,"ganancia")}" class="v">—</span></div>
            <div class="kpi">Estado cartilla: <span id="${kIdB(bi,key,"ticketStatus")}" class="v">—</span></div>
            <div class="kpi">Retorno efectivo: <span id="${kIdB(bi,key,"retornoEfectivo")}" class="v">—</span></div>
            <div class="kpi">Ganancia efectiva: <span id="${kIdB(bi,key,"gananciaEfectiva")}" class="v">—</span></div>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <button id="${kIdB(bi,key,"recalcBtn")}" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-500">Recalcular</button>
            <button id="${kIdB(bi,key,"clearResultsBtn")}" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpiar resultados</button>
            <button id="${kIdB(bi,key,"exportJSON")}" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">JSON</button>
            <button id="${kIdB(bi,key,"exportCSV")}" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">CSV</button>
          </div>
          <div class="overflow-auto rounded-xl border border-slate-200 mt-2">
            <table id="${kIdB(bi,key,"table")}" class="ticket-table"></table>
          </div>
        </div>
      `;

      if (t.label === "Mixta" || key === "mixta") {
        const container = wrap.querySelector("#"+kIdB(bi,key,"mixtaSummaryWrap"));
        const map = new Map();
        t.lines.forEach(it => {
          const s = it.sport || "Otro";
          const dec = toDecimalFactor(it.factor);
          const cur = map.get(s) || {count:0, prod:1.0, any:false};
          if (dec && dec>0) { cur.prod *= dec; cur.any = true; }
          cur.count += 1; map.set(s, cur);
        });
        const box = document.createElement("div");
        box.className = "overflow-auto rounded-xl border border-slate-200";
        const tbl = document.createElement("table");
        const thead = document.createElement("thead");
        const thr = document.createElement("tr");
        ["Deporte","Líneas","ODD total (decimal)"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; thr.appendChild(th); });
        thead.appendChild(thr); tbl.appendChild(thead);
        const tbody = document.createElement("tbody");
        Array.from(map.entries()).forEach(([sport, info]) => {
          const tr = document.createElement("tr");
          function td(v){ const td=document.createElement("td"); td.textContent=v; return td; }
          tr.appendChild(td(sport)); tr.appendChild(td(String(info.count))); tr.appendChild(td(info.any ? info.prod.toFixed(4) : "—"));
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody); box.appendChild(tbl);
        if (container) container.appendChild(box);
      }

      const table = wrap.querySelector("#"+kIdB(bi,key,"table"));
      const headers=["sport","winner","stat","umbral","valor","tipo","faltan","factor","resultado","_status","_actions"];
      const pretty =["Sport","Winner","stat","umbral","valor","tipo","faltan","factor*","Resultado","Estado","Acciones"];
      const thead=document.createElement("thead"); const thr=document.createElement("tr");
      pretty.forEach((c,ci)=>{ const th=document.createElement("th"); th.textContent=c; if(ci===8) th.classList.add("col-res"); if(ci===9) th.classList.add("col-status"); thr.appendChild(th); });
      thead.appendChild(thr); table.appendChild(thead);
      const tbody=document.createElement("tbody");
      t.lines.forEach((it, idx)=>{
        const tr=document.createElement("tr");
        function tdText(v, cls){ const td=document.createElement("td"); td.textContent=(v??""); if(cls) td.className = cls; return td; }
        tr.appendChild(tdText(it.sport, "col-sport"));
        tr.appendChild(tdText(it.winner, "col-winner"));
        tr.appendChild(tdText(it.stat||"", "col-stat"));
        tr.appendChild(tdText((it.umbral!=null && it.umbral!=="") ? it.umbral : "", "col-umbral num nowrap"));
        const tdVal=document.createElement("td"); tdVal.className="col-valor";

        const inpVal=document.createElement("input"); inpVal.type="text"; inpVal.placeholder="valor"; inpVal.className="num-input rounded-lg border border-slate-200";
        inpVal.value = (it.valor ?? ""); inpVal.addEventListener("input",(e)=>{ const nv = e.target.value; it.valor = nv === "" ? "" : Number(nv); autoEvalResult(it); updateRowStatusB(bi, key, idx); computeEffectiveForB(bi, key); }); tdVal.appendChild(inpVal); tr.appendChild(tdVal);
        const tdTipo=document.createElement("td"); tdTipo.className="col-tipo"; const sel=document.createElement("select"); sel.className="rounded-lg border border-slate-200 px-2 py-1.5"; ["over","under"].forEach(opt=>{ const o=document.createElement("option"); o.value=opt; o.textContent=opt.toUpperCase(); sel.appendChild(o); }); sel.value = (it.tipo && ["over","under"].includes(String(it.tipo).toLowerCase())) ? String(it.tipo).toLowerCase() : "over"; sel.addEventListener("change", ()=>{ it.tipo = sel.value; autoEvalResult(it); updateRowStatusB(bi, key, idx); refreshDeltaForRow(bi, key, idx); computeEffectiveForB(bi, key); }); tdTipo.appendChild(sel); tr.appendChild(tdTipo);
        const tdFactor=document.createElement("td"); tdFactor.className="col-factor"; const inpF=document.createElement("input"); inpF.type="text"; inpF.placeholder="1.85 o +120"; inpF.className="num-input factor rounded-lg border border-slate-200"; inpF.value = (it.factor ?? ""); inpF.addEventListener("input",(e)=>{ const nv=e.target.value; const norm=normalizeOdds(nv); it.factor = norm ? norm.value : nv; computeTotalsForB(bi, key); computeEffectiveForB(bi, key); }); tdFactor.appendChild(inpF); tr.appendChild(tdFactor);
        
        const tdRes = document.createElement("td"); tdRes.className="col-res col-resultado";
        if(it.umbral!=null && it.umbral!==""){ const span = document.createElement("span"); span.textContent = it.resultado || ""; setResultTextStyle(span, it); tdRes.appendChild(span); }
        else { const inp = document.createElement("input"); inp.type="text"; inp.placeholder="Ganado/Perdido"; inp.className="w-full rounded-lg border border-slate-200 p-1.5"; inp.value = it.resultado || ""; inp.addEventListener("input", (e)=>{ it.resultado = e.target.value; updateRowStatusB(bi, key, idx); computeEffectiveForB(bi, key); }); tdRes.appendChild(inp); }
        tr.appendChild(tdRes);
        const tdStatus=document.createElement("td"); tdStatus.className="col-status col-estado"; tdStatus.dataset.idx=idx; tr.appendChild(tdStatus);
        setRowBadge(tdStatus, it);
        const tdAct=document.createElement("td"); tdAct.className="col-actions"; const btnWin=document.createElement("button"); btnWin.className="btn"; btnWin.textContent="✓ Ganado"; btnWin.addEventListener("click", ()=>{ it.resultado="Ganado"; updateRowStatusB(bi, key, idx); computeEffectiveForB(bi, key); }); tdAct.appendChild(btnWin); tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      return wrap;
    }function renderTabs(){
      const nav = $("tabsNav"); const content = $("tabsContent");
      nav.innerHTML=""; content.innerHTML="";
      const n = state.booklets.length;
      if(!n){ content.innerHTML='<div class="text-sm text-slate-500">Carga un archivo para generar cartillas.</div>'; return; }
      for(let i=0;i<n;i++){
        const btn=document.createElement("button"); btn.className="px-3 py-1.5 rounded-lg"; btn.textContent=state.booklets[i].label;
        if(state.activeBooklet===i) btn.classList.add("active");
        btn.addEventListener("click", ()=>{ state.activeBooklet=i; renderTabs(); });
        nav.appendChild(btn);
      }
      const bi = state.activeBooklet;
      const node = renderTicketContentB(bi);
      content.appendChild(node);
      const t = state.booklets[bi].ticket; const key = t.key;
      document.getElementById(kIdB(bi,key,"stake")).addEventListener("input", ()=>{ computeTotalsForB(bi, key); computeEffectiveForB(bi, key); });
      document.getElementById(kIdB(bi,key,"pendingMode")).addEventListener("change", ()=>{ computeEffectiveForB(bi, key); });
      document.getElementById(kIdB(bi,key,"recalcBtn")).addEventListener("click", ()=>{ computeTotalsForB(bi, key); computeEffectiveForB(bi, key); });
      document.getElementById(kIdB(bi,key,"clearResultsBtn")).addEventListener("click", ()=>{ state.booklets[bi].ticket.lines.forEach(it=>{ it.valor=""; it.resultado=""; }); renderTabs(); });
      document.getElementById(kIdB(bi,key,"exportJSON")).addEventListener("click", ()=>{ const t=state.booklets[bi].ticket; const blob=new Blob([JSON.stringify(t.lines,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`cartilla_${bi+1}_${key}_lines.json`; a.click(); URL.revokeObjectURL(a.href); });
      document.getElementById(kIdB(bi,key,"exportCSV")).addEventListener("click", ()=>{ const t=state.booklets[bi].ticket; const cols=["sport","winner","stat","umbral","valor","tipo","faltan","factor","resultado"]; const head=cols.join(",")+"\n"; const rows=t.lines.map(it=>cols.map(k=>{ const v = (k==="faltan") ? computeDelta(it) : (it[k]??""); return (\"\"+String(v).replace(/\\"/g,'\\"')+\"\"); }).join(",")).join("\n"); const blob=new Blob([head+rows],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`cartilla_${bi+1}_${key}_lines.csv`; a.click(); URL.revokeObjectURL(a.href); });
      applyHideCols();
      computeTotalsForB(bi, key); computeEffectiveForB(bi, key);
    }// Global events
    document.getElementById("dropzone").addEventListener("dragover", e=>{ e.preventDefault(); e.currentTarget.classList.add("bg-indigo-50","border-indigo-300"); });
    document.getElementById("dropzone").addEventListener("dragleave", e=>{ e.preventDefault(); e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300"); });
    document.getElementById("dropzone").addEventListener("drop", handleDrop);
    document.getElementById("fileInput").addEventListener("change", e=>{ if(e.target.files && e.target.files[0]) loadFile(e.target.files[0]); });
    document.getElementById("parseBtn").addEventListener("click", parseSheet);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    document.getElementById("hideResultsChk").addEventListener("change", applyHideCols);
    document.getElementById("saveBtn").addEventListener("click", saveBooklets);
    document.getElementById("restoreBtn").addEventListener("click", loadBooklets);
    document.getElementById("clearSavedBtn").addEventListener("click", clearSaved);
  </script>
<script src="../../assets/site.js"></script>
  <script>window.Site && window.Site.auto();</script>
</body>
</html>
