<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBets — Columna A (“apuesta”)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="description" content="Lee Excel donde la columna A se llama 'apuesta' y contiene toda la línea; filas 2..N son datos." />
  <style>
    .card{transition:box-shadow .2s ease, transform .2s ease}
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.08);transform:translateY(-2px)}
    .drop{border:2px dashed #cbd5e1}
    table{border-collapse: separate; border-spacing: 0; min-width: 100%}
    th, td{border-bottom:1px solid #e5e7eb; padding:6px 10px; text-align:left; font-size:12px}
    th{position: sticky; top:0; background:#f8fafc; z-index:1}
    .bad{background:#fff7ed} .good{background:#f0fdf4}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="site-navbar"></div>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">SportsBets — Columna A</h1>
      <div class="text-sm text-slate-500">v1.8</div>
    </div>
    <p class="mt-2 text-slate-600">Formato esperado: <span class="font-mono">A1 = "apuesta"</span>; desde <span class="font-mono">A2</span> en adelante, cada celda contiene una línea con: <em>Ganador, Odd, Tipo, Equipos</em>. Podemos detectar los campos con etiquetas (p. ej., <em>Ganador: X | Odd: 1.85 | Tipo: Ganador | Equipos: A vs B</em>) o heurísticas.</p>

    <section class="mt-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
      <div class="lg:col-span-2 space-y-6">
        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">1) Cargar archivo</h2>
          <div id="dropzone" class="drop rounded-xl p-6 text-center bg-slate-50">
            <p class="text-sm text-slate-600 mb-2">Arrastra y suelta aquí, o</p>
            <label class="inline-block px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm cursor-pointer hover:bg-indigo-500">
              Seleccionar archivo
              <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
            </label>
            <p id="fileInfo" class="mt-2 text-xs text-slate-500">Sin archivo</p>
          </div>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label class="block text-sm font-medium mb-1">Hoja</label><select id="sheetSel" class="w-full rounded-xl border border-slate-200 p-2.5"></select></div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <button id="parseBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Leer</button>
            <button id="clearBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpiar</button>
          </div>
        </div>

        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">2) Construir & Validar</h2>
          <label class="flex items-center gap-2 text-sm">
            <input id="validateOn" type="checkbox" class="h-4 w-4" checked> Validar ganador ∈ {home, away} (o 'Empate' en Fútbol)
          </label>
          <button id="buildBtn" class="mt-3 px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-500">Construir líneas</button>
          <div id="summary" class="mt-3 text-xs text-slate-500"></div>
        </div>

        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">Exportar</h2>
          <div class="flex items-center gap-2">
            <button id="exportJSON" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Descargar JSON</button>
            <button id="exportCSV" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Descargar CSV</button>
          </div>
        </div>
      </div>

      <div class="lg:col-span-3 space-y-6">
        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Previsualización (A)</h2>
            <div class="text-xs text-slate-500"><span id="previewCount">0</span> filas</div>
          </div>
          <div class="overflow-auto rounded-xl border border-slate-200">
            <table id="previewTable"></table>
          </div>
        </div>

        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Líneas construidas</h2>
            <div class="text-xs text-slate-500"><span id="builtCount">0</span> elementos</div>
          </div>
          <div class="overflow-auto rounded-xl border border-slate-200">
            <table id="builtTable"></table>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div id="site-footer"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { wb:null, fileName:null, lines:[], built:[], sheet:null };

    function setFileInfo(txt){ $("fileInfo").textContent = txt; }
    function clearAll(){
      state.wb=null; state.fileName=null; state.lines=[]; state.built=[]; state.sheet=null;
      $("sheetSel").innerHTML = ""; setFileInfo("Sin archivo");
      renderPreview([]); renderBuilt([]); $("summary").textContent="";
    }
    function handleDrop(e){
      e.preventDefault(); e.stopPropagation();
      const dt=e.dataTransfer; if(!dt || !dt.files || !dt.files[0]) return;
      const f=dt.files[0]; $("fileInput").files = dt.files; loadFile(f);
      e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300");
    }
    function loadFile(file){
      state.fileName=file.name;
      setFileInfo("Archivo: "+file.name+" ("+Math.round(file.size/1024)+" KB)");
      const reader=new FileReader();
      reader.onload = function(ev){
        try{
          const data=new Uint8Array(ev.target.result);
          state.wb = XLSX.read(data, { type:'array' });
          populateSheets();
        }catch(err){ alert("No se pudo leer el archivo."); console.error(err); }
      };
      reader.readAsArrayBuffer(file);
    }
    function populateSheets(){
      const sheets = state.wb.SheetNames || [];
      const sel = $("sheetSel"); sel.innerHTML="";
      sheets.forEach((s,i)=>{ const opt=document.createElement("option"); opt.value=s; opt.textContent=s+(i===0?" (sugerida)":""); sel.appendChild(opt); });
      state.sheet = sheets[0] || null;
    }
    function renderPreview(lines){
      const table = $("previewTable"); table.innerHTML="";
      const thead=document.createElement("thead"); const thr=document.createElement("tr");
      ["Fila","apuesta"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; thr.appendChild(th); });
      thead.appendChild(thr); table.appendChild(thead);
      const tbody=document.createElement("tbody"); const MAX=200;
      lines.slice(0,MAX).forEach((t,i)=>{
        const tr=document.createElement("tr");
        const td1=document.createElement("td"); td1.textContent=(i+2); tr.appendChild(td1);
        const td2=document.createElement("td"); td2.textContent=(t ?? ""); tr.appendChild(td2);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      $("previewCount").textContent = lines.length.toString();
    }
    function parseSheet(){
      const sheetName = $("sheetSel").value || state.sheet;
      if(!sheetName){ alert("No hay hojas."); return; }
      const ws = state.wb.Sheets[sheetName];
      // Leer toda la hoja como matriz
      const arr = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
      if(!arr || !arr.length){ renderPreview([]); return; }
      // Esperamos A1 = "apuesta"; desde A2 datos
      const header = (arr[0] && arr[0][0] ? arr[0][0].toString().trim().toLowerCase() : "");
      if(header !== "apuesta"){
        // si no coincide, igual intentamos tomando la primera columna
        console.warn("A1 no es 'apuesta', detectado:", header);
      }
      const lines = [];
      for(let i=1;i<arr.length;i++){
        const row = arr[i];
        const val = row && row.length ? String(row[0] ?? "").trim() : "";
        if(val) lines.push(val);
      }
      state.sheet = sheetName;
      state.lines = lines;
      renderPreview(lines);
    }
    function normalizeOdds(v){
      const s = (v ?? "").toString().trim().replace(",", ".");
      if(!s) return null;
      if(/^[+-]\d+(?:\.\d+)?$/.test(s)) return { type:"american", value: parseFloat(s) };
      const num = Number(s); if(Number.isFinite(num)) return { type:"decimal", value: num };
      return { type:"raw", value: (v ?? "").toString() };
    }
    function splitTeams(raw){
      if(!raw) return {home:"",away:""};
      const s = raw.toString();
      const seps = [" vs ", " vs. ", " v ", " @ ", " - ", " — ", " – "];
      for(const sep of seps){ if(s.includes(sep)){ const [a,b]=s.split(sep,1); return {home:(a||"").trim(), away:(b||"").trim()}; } }
      const m = s.split(/\s+(?:vs\.?|v|@|\-+|—|–)\s+/i);
      if(m.length>=2) return {home:(m[0]||"").trim(), away:(m[1]||"").trim()};
      return {home:s.trim(), away:""};
    }
    function inferSport(typeStr){
      const t=(typeStr||"").toString().toLowerCase();
      if(t === "ganador") return "Tenis";
      if(t.includes("resultado del partido") || (t.includes("resultado") && t.includes("partido"))) return "Fútbol";
      return "";
    }
    function extractLabeled(s, key){
      const re = {
        winner: /(ganador|winner|selecci[oó]n|pick)\s*[:=-]\s*([^|;,\n]+)/i,
        odd: /(odd|odds|cuota|price|momio|decimal|american)\s*[:=-]\s*([+\-]?\d+(?:[.,]\d+)?)/i,
        type: /(tipo|type|market|mercado|apuesta|resultado(?:\s+del)?\s+partido|ganador)\s*[:=-]\s*([^|;,\n]+)/i,
        teams: /(equipos|match|game|partido)\s*[:=-]\s*([^|\n]+)/i
      }[key];
      const m = re ? s.match(re) : null;
      if(!m) return "";
      return (m[2] || m[3] || "").trim();
    }
    function fallbackOdd(s){
      const m = s.match(/([+\-]?\d+(?:[.,]\d+)?)/);
      return m ? m[1] : "";
    }
    function buildLines(){
      const validate = $("validateOn").checked;
      const built = state.lines.map(line => {
        const winnerL = extractLabeled(line, "winner");
        const oddL = extractLabeled(line, "odd") || fallbackOdd(line);
        const typeL = extractLabeled(line, "type");
        const teamsL = extractLabeled(line, "teams");
        const teamsStr = teamsL || line; // por si viene inline sin etiqueta
        const teams = splitTeams(teamsStr);
        const sport = inferSport(typeL);
        const odd = normalizeOdds(oddL);
        const winner = winnerL || ""; // si no hay etiqueta, no arriesgamos heurística
        // Validación
        let valid=true, note="OK";
        const w = (winner||"").toString().trim().toLowerCase();
        const h = (teams.home||"").toString().trim().toLowerCase();
        const a = (teams.away||"").toString().trim().toLowerCase();
        if(validate){
          if(!w){ valid=false; note="Winner vacío"; }
          else if(sport==="Fútbol"){
            if(w!=="empate" && w!==h && w!==a){ valid=false; note="Winner no coincide con equipos"; }
          } else if(sport==="Tenis"){
            if(w!==h && w!==a){ valid=false; note="Winner no coincide con jugadores"; }
          }
        }
        return { sport, winner, odd_type: odd?odd.type:"", odd_value: odd?odd.value:"", type: typeL, home: teams.home, away: teams.away, teamsRaw: teamsStr, valid, note };
      });
      state.built = built;
      renderBuilt(built);
      const total=built.length, bad=built.filter(x=>!x.valid).length;
      $("summary").textContent = `Construidas: ${total} • Inválidas: ${bad} • Válidas: ${total-bad}`;
    }
    function renderBuilt(items){
      const table = $("builtTable"); table.innerHTML="";
      $("builtCount").textContent = (items?items.length:0).toString();
      if(!items || !items.length) return;
      const headers=["sport","winner","odd_type","odd_value","type","home","away","valid","note","teamsRaw"];
      const pretty=["Deporte","Ganador","Odd(tipo)","Odd(valor)","Tipo","Home","Away","Válida","Nota","Equipos(raw)"];
      const thead=document.createElement("thead"); const thr=document.createElement("tr");
      pretty.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; thr.appendChild(th); });
      thead.appendChild(thr); table.appendChild(thead);
      const tbody=document.createElement("tbody"); const MAX=500;
      items.slice(0,MAX).forEach(it=>{
        const tr=document.createElement("tr"); tr.className = it.valid?"good":"bad";
        headers.forEach(k=>{ const td=document.createElement("td"); td.textContent=(it[k]??""); tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
    function exportJSON(){
      const blob=new Blob([JSON.stringify(state.built,null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="sportsbets_lines_from_colA.json"; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportCSV(){
      if(!state.built.length){ alert("No hay líneas."); return; }
      const cols=["sport","winner","odd_type","odd_value","type","home","away","valid","note","teamsRaw"];
      const head=cols.join(",")+"\n";
      const rows=state.built.map(it=>cols.map(k=>('"'+String(it[k]??"").replace(/"/g,'""')+'"')).join(",")).join("\n");
      const blob=new Blob([head+rows],{type:"text/csv;charset=utf-8;"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="sportsbets_lines_from_colA.csv"; a.click(); URL.revokeObjectURL(a.href);
    }
    // Events
    $("dropzone").addEventListener("dragover", e=>{ e.preventDefault(); e.currentTarget.classList.add("bg-indigo-50","border-indigo-300"); });
    $("dropzone").addEventListener("dragleave", e=>{ e.preventDefault(); e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300"); });
    $("dropzone").addEventListener("drop", handleDrop);
    $("fileInput").addEventListener("change", e=>{ if(e.target.files && e.target.files[0]) loadFile(e.target.files[0]); });
    $("parseBtn").addEventListener("click", parseSheet);
    $("clearBtn").addEventListener("click", clearAll);
    $("buildBtn").addEventListener("click", buildLines);
    $("exportJSON").addEventListener("click", exportJSON);
    $("exportCSV").addEventListener("click", exportCSV);
  </script>

  <script src="../../assets/site.js"></script>
  <script>window.Site && window.Site.auto();</script>
</body>
</html>
