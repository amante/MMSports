<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBets — Cartilla</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="description" content="Importa Excel en bloques de 4 (A1: Ganador, A2: Odd, A3: Tipo, A4: Partido). Muestra Sport, Winner, factor, Home, Away; calcula ODD total y retorno; permite marcar Ganado por fila, limpiar resultados y seleccionar el modo de pendientes." />
  <style>
    .card{transition:box-shadow .2s ease, transform .2s ease}
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.08);transform:translateY(-2px)}
    .drop{border:2px dashed #cbd5e1}
    table{border-collapse: separate; border-spacing: 0; min-width: 100%}
    th, td{border-bottom:1px solid #e5e7eb; padding:6px 10px; text-align:left; font-size:12px}
    th{position: sticky; top:0; background:#f8fafc; z-index:1}
    .badge{font-size:10px; padding:2px 6px; border-radius:999px; display:inline-block}
    .badge-green{background:#dcfce7;color:#065f46;border:1px solid #86efac}
    .badge-red{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .badge-gray{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    .kpi{background:white;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px}
    .kpi .v{font-weight:600}
    .btn{border:1px solid #e5e7eb;border-radius:10px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="site-navbar"></div>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">SportsBets — Cartilla</h1>
      <div class="text-sm text-slate-500">v1.13</div>
    </div>

    <section class="mt-6 grid grid-cols-1 lg:grid-cols-5 gap-6">
      <div class="lg:col-span-2 space-y-6">
        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">1) Cargar archivo</h2>
          <div id="dropzone" class="drop rounded-xl p-6 text-center bg-slate-50">
            <p class="text-sm text-slate-600 mb-2">Arrastra y suelta aquí, o</p>
            <label class="inline-block px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm cursor-pointer hover:bg-indigo-500">
              Seleccionar archivo
              <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
            </label>
            <p id="fileInfo" class="mt-2 text-xs text-slate-500">Sin archivo</p>
          </div>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label class="block text-sm font-medium mb-1">Hoja</label><select id="sheetSel" class="w-full rounded-xl border border-slate-200 p-2.5"></select></div>
            <div><label class="block text-sm font-medium mb-1">Fila inicial</label><input id="startRow" type="number" min="1" step="1" value="1" class="w-full rounded-xl border border-slate-200 p-2.5" /></div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <button id="parseBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Leer</button>
            <button id="clearBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpiar</button>
          </div>
        </div>

        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">2) Parámetros</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
            <div>
              <label class="block text-sm font-medium mb-1">Monto (stake)</label>
              <input id="stake" type="number" min="0" step="0.01" value="10" class="w-full rounded-xl border border-slate-200 p-2.5" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Modo de pendientes</label>
              <select id="pendingMode" class="w-full rounded-xl border border-slate-200 p-2.5">
                <option value="ignore1">Pendientes = 1 (retorno parcial por ganadas)</option>
                <option value="strict0">Parlay estricto (pendientes = 0)</option>
              </select>
            </div>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <button id="buildBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-500">Construir</button>
            <button id="clearResultsBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Limpiar resultados</button>
          </div>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="kpi">ODD total (decimal): <span id="oddTotal" class="v">—</span></div>
            <div class="kpi">Retorno potencial: <span id="retorno" class="v">—</span></div>
            <div class="kpi">Ganancia neta: <span id="ganancia" class="v">—</span></div>
            <div class="kpi">Estado cartilla: <span id="ticketStatus" class="v">—</span></div>
            <div class="kpi">Retorno efectivo: <span id="retornoEfectivo" class="v">—</span></div>
            <div class="kpi">Ganancia neta efectiva: <span id="gananciaEfectiva" class="v">—</span></div>
          </div>
        </div>

        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <h2 class="text-lg font-semibold mb-3">Exportar</h2>
          <div class="flex items-center gap-2">
            <button id="exportJSON" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hover:bg-slate-700">Descargar JSON</button>
            <button id="exportCSV" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm hover:bg-slate-300">Descargar CSV</button>
          </div>
        </div>
      </div>

      <div class="lg:col-span-3 space-y-6">
        <div class="card bg-white rounded-2xl p-5 border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Líneas</h2>
            <div class="text-xs text-slate-500"><span id="builtCount">0</span> elementos</div>
          </div>
          <div class="overflow-auto rounded-xl border border-slate-200">
            <table id="builtTable"></table>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div id="site-footer"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { wb:null, fileName:null, linesA:[], built:[], sheet:null };

    function setFileInfo(txt){ $("fileInfo").textContent = txt; }
    function clearAll(){
      state.wb=null; state.fileName=null; state.linesA=[]; state.built=[]; state.sheet=null;
      $("sheetSel").innerHTML = ""; 
      ["oddTotal","retorno","ganancia","ticketStatus","retornoEfectivo","gananciaEfectiva"].forEach(id=>$(id).textContent="—");
      renderBuilt([]);
    }
    function handleDrop(e){
      e.preventDefault(); e.stopPropagation();
      const dt=e.dataTransfer; if(!dt || !dt.files || !dt.files[0]) return;
      const f=dt.files[0]; $("fileInput").files = dt.files; loadFile(f);
      e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300");
    }
    function loadFile(file){
      state.fileName=file.name; 
      const info = "Archivo: "+file.name+" ("+Math.round(file.size/1024)+" KB)";
      const node = document.getElementById("fileInfo"); if(node) node.textContent = info;
      const reader=new FileReader();
      reader.onload = function(ev){
        try{ const data=new Uint8Array(ev.target.result); state.wb = XLSX.read(data, { type:'array' }); populateSheets(); }
        catch(err){ alert("No se pudo leer el archivo."); console.error(err); }
      };
      reader.readAsArrayBuffer(file);
    }
    function populateSheets(){
      const sheets = state.wb.SheetNames || [];
      const sel = $("sheetSel"); sel.innerHTML="";
      sheets.forEach((s,i)=>{ const opt=document.createElement("option"); opt.value=s; opt.textContent=s+(i===0?" (sugerida)":""); sel.appendChild(opt); });
      state.sheet = sheets[0] || null;
    }
    function parseSheet(){
      const sheetName = $("sheetSel").value || state.sheet;
      if(!sheetName){ alert("No hay hojas."); return; }
      const ws = state.wb.Sheets[sheetName];
      const arr = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
      const lines = [];
      for(let i=0;i<arr.length;i++){
        const row = arr[i];
        const val = row && row.length ? String(row[0] ?? "").trim() : "";
        lines.push(val);
      }
      state.sheet = sheetName;
      state.linesA = lines;
      buildLines();
    }
    function normalizeOdds(v){
      const s = (v ?? "").toString().trim().replace(",", ".");
      if(!s) return null;
      if(/^[+-]\d+(?:\.\d+)?$/.test(s)) return { type:"american", value: parseFloat(s) };
      const num = Number(s); if(Number.isFinite(num)) return { type:"decimal", value: num };
      return { type:"raw", value: (v ?? "").toString() };
    }
    function toDecimalFactor(f){
      const x = Number(f);
      if(!Number.isFinite(x)) return null;
      if(Math.abs(x) >= 100 || x <= -100 || x >= 100){
        if(x > 0) return 1 + (x/100);
        if(x < 0) return 1 + (100/Math.abs(x));
      }
      if(x >= 1.01) return x;
      return null;
    }
    function splitTeams(raw){
      if(!raw) return {home:"",away:""};
      const s = raw.toString();
      const seps = [" vs ", " vs. ", " v ", " @ ", " - ", " — ", " – "];
      for(const sep of seps){ if(s.includes(sep)){ const parts=s.split(sep); if(parts.length>=2){ return {home:(parts[0]||"").trim(), away:(parts[1]||"").trim()}; } } }
      const m = s.split(/\s+(?:vs\.?|v|@|\-+|—|–)\s+/i);
      if(m.length>=2) return {home:(m[0]||"").trim(), away:(m[1]||"").trim()};
      return {home:s.trim(), away:""};
    }
    function inferSport(typeStr){
      const t=(typeStr||"").toString().trim().toLowerCase();
      if(t === "ganador") return "Tenis";
      if(t.includes("resultado del partido") || (t.includes("resultado") && t.includes("partido"))) return "Fútbol";
      return "";
    }
    function buildLines(){
      const arr = state.linesA;
      const built = [];
      for(let i=0; i < arr.length; i += 4){
        const a1 = arr[i]     || ""; // Ganador
        const a2 = arr[i+1]   || ""; // Odd
        const a3 = arr[i+2]   || ""; // Tipo
        const a4 = arr[i+3]   || ""; // Partido
        if(!a1 && !a2 && !a3 && !a4) continue;
        const sport = inferSport(a3);
        const teams = splitTeams(a4);
        const odd = normalizeOdds(a2);
        built.push({ sport, winner: a1, factor: odd?odd.value:"", home: teams.home, away: teams.away, resultado: "" });
      }
      state.built = built;
      renderBuilt(built);
      computeTotals();
      computeEffective();
    }
    function computeTotals(){
      const stake = Number($("stake").value || 0);
      let prod = 1.0; let count=0;
      for(const it of state.built){
        const dec = toDecimalFactor(it.factor);
        if(dec && dec>0){ prod *= dec; count++; }
      }
      const oddTotal = (count>0) ? prod : 0;
      const retorno = oddTotal * stake;
      const ganancia = retorno - stake;
      $("oddTotal").textContent = (oddTotal? oddTotal.toFixed(4) : "—");
      $("retorno").textContent = (oddTotal? retorno.toFixed(2) : "—");
      $("ganancia").textContent = (oddTotal? ganancia.toFixed(2) : "—");
    }
    function classifyResult(v){
      const s = (v||"").toString().trim().toLowerCase();
      const noAcc = s.normalize('NFD').replace(/\p{Diacritic}/gu, '');
      const winSet = new Set(["ganado","ganada","win","won","ok","si","sí","yes","true"]);
      const loseSet = new Set(["perdido","perdida","lose","lost","no","fail","false"]);
      const pendSet = new Set(["pendiente","pending","-","—","en curso","running"]);
      const s2 = noAcc;
      if(winSet.has(s2)) return "ganado";
      if(loseSet.has(s2)) return "perdido";
      if(!s2 || pendSet.has(s2)) return "pendiente";
      return "pendiente";
    }
    function computeEffective(){
      const stake = Number($("stake").value || 0);
      const mode = $("pendingMode").value; // 'ignore1' or 'strict0'
      let hasLost=false, allWon=true, hasPending=false;
      let prodWins = 1.0; let wins=0;
      for(const it of state.built){
        const cls = classifyResult(it.resultado);
        if(cls === "perdido") hasLost = true;
        if(cls !== "ganado") allWon = false;
        if(cls === "pendiente") hasPending = true;
        if(cls === "ganado"){
          const dec = toDecimalFactor(it.factor);
          if(dec && dec>0){ prodWins *= dec; wins++; }
        }
      }
      let status = "Pendiente";
      let retornoEf = 0, ganEf = 0, showNums=false;
      if(hasLost){
        status = "Perdida"; retornoEf = 0; showNums = true; ganEf = -stake;
      }else if(allWon && wins>0){
        status = "Ganada"; retornoEf = prodWins * stake; showNums = true; ganEf = retornoEf - stake;
      }else{
        status = "Pendiente";
        if(mode === "ignore1"){
          // Solo multiplicamos ganadas; pendientes cuentan como 1
          retornoEf = wins>0 ? (prodWins * stake) : 0;
          showNums = wins>0;
          ganEf = showNums ? (retornoEf - stake) : 0;
        }else{
          // strict0: pendientes = 0 → retorno 0 hasta resolver
          retornoEf = 0; showNums = False;
          ganEf = 0;
        }
      }
      $("ticketStatus").textContent = status;
      $("retornoEfectivo").textContent = showNums ? retornoEf.toFixed(2) : "—";
      $("gananciaEfectiva").textContent = showNums ? (ganEf.toFixed(2)) : "—";
    }
    function tableStatusBadge(td, it){
      td.innerHTML = "";
      const cls = classifyResult(it.resultado);
      if(cls === "ganado"){
        const b=document.createElement("span"); b.className="badge badge-green"; b.textContent="Ganado"; td.appendChild(b);
      }else if(cls === "perdido"){
        const b=document.createElement("span"); b.className="badge badge-red"; b.textContent="Perdido"; td.appendChild(b);
      }else{
        const b=document.createElement("span"); b.className="badge badge-gray"; b.textContent="Pendiente"; td.appendChild(b);
      }
    }
    function renderBuilt(items){
      const table = $("builtTable"); table.innerHTML="";
      $("builtCount").textContent = (items?items.length:0).toString();
      if(!items || !items.length) return;
      const headers=["sport","winner","factor","home","away","resultado","_status","_actions"];
      const pretty =["Sport","Winner","factor","Home","Away","Resultado","Estado","Acciones"];
      const thead=document.createElement("thead"); const thr=document.createElement("tr");
      pretty.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; thr.appendChild(th); });
      thead.appendChild(thr); table.appendChild(thead);
      const tbody=document.createElement("tbody");
      items.forEach((it, idx)=>{
        const tr=document.createElement("tr");
        function tdText(v){ const td=document.createElement("td"); td.textContent=(v??""); return td; }
        tr.appendChild(tdText(it.sport));
        tr.appendChild(tdText(it.winner));
        tr.appendChild(tdText(it.factor));
        tr.appendChild(tdText(it.home));
        tr.appendChild(tdText(it.away));
        // Resultado input
        const tdRes = document.createElement("td");
        const inp = document.createElement("input"); inp.type="text"; inp.placeholder="Ganado/Perdido"; inp.className="w-full rounded-lg border border-slate-200 p-1.5";
        inp.value = it.resultado || "";
        inp.addEventListener("input", (e)=>{ it.resultado = e.target.value; updateStatus(idx); computeEffective(); });
        tdRes.appendChild(inp); tr.appendChild(tdRes);
        // Status badge
        const tdStatus = document.createElement("td"); tdStatus.dataset.idx = idx; tr.appendChild(tdStatus);
        tableStatusBadge(tdStatus, it);
        // Acciones
        const tdAct = document.createElement("td");
        const btnWin = document.createElement("button"); btnWin.className="btn"; btnWin.textContent = "✓ Ganado";
        btnWin.addEventListener("click", ()=>{ it.resultado = "Ganado"; // force update input too
          inp.value = it.resultado; updateStatus(idx); computeEffective(); });
        tdAct.appendChild(btnWin);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
    function updateStatus(idx){
      const tdList = document.querySelectorAll("#builtTable tbody tr td:nth-child(7)"); // Estado column
      const it = state.built[idx];
      const td = tdList[idx];
      if(td) tableStatusBadge(td, it);
    }
    function clearResults(){
      for(const it of state.built){ it.resultado = ""; }
      renderBuilt(state.built);
      computeEffective();
    }
    function exportJSON(){
      const blob=new Blob([JSON.stringify(state.built,null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="sportsbets_lines_with_results.json"; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportCSV(){
      if(!state.built.length){ alert("No hay líneas."); return; }
      const cols=["sport","winner","factor","home","away","resultado"];
      const head=cols.join(",")+"\n";
      const rows=state.built.map(it=>cols.map(k=>('"'+String(it[k]??"").replace(/"/g,'""')+'"')).join(",")).join("\n");
      const blob=new Blob([head+rows],{type:"text/csv;charset=utf-8;"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="sportsbets_lines_with_results.csv"; a.click(); URL.revokeObjectURL(a.href);
    }
    // Events
    $("dropzone").addEventListener("dragover", e=>{ e.preventDefault(); e.currentTarget.classList.add("bg-indigo-50","border-indigo-300"); });
    $("dropzone").addEventListener("dragleave", e=>{ e.preventDefault(); e.currentTarget.classList.remove("bg-indigo-50","border-indigo-300"); });
    $("dropzone").addEventListener("drop", handleDrop);
    $("fileInput").addEventListener("change", e=>{ if(e.target.files && e.target.files[0]) loadFile(e.target.files[0]); });
    $("parseBtn").addEventListener("click", parseSheet);
    $("clearBtn").addEventListener("click", clearAll);
    $("buildBtn").addEventListener("click", ()=>{ buildLines(); computeTotals(); computeEffective(); });
    $("stake").addEventListener("input", ()=>{ computeTotals(); computeEffective(); });
    $("pendingMode").addEventListener("change", computeEffective);
    $("clearResultsBtn").addEventListener("click", clearResults);
  </script>

  <script src="../../assets/site.js"></script>
  <script>window.Site && window.Site.auto();</script>
</body>
</html>
